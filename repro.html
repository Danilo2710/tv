<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor Universal</title>
    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #0f1419;
            color: #e1e1e1;
            overflow-x: hidden;
        }
        
        /* Estilos para la pantalla de redirección */
        .redirect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 20, 25, 0.98);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .redirect-content {
            text-align: center;
            padding: 40px;
            background: #1a1f26;
            border-radius: 12px;
            border: 2px solid #e50914;
            max-width: 500px;
            margin: 20px;
        }
        
        .redirect-logo {
            font-size: 36px;
            font-weight: bold;
            color: #e50914;
            margin-bottom: 20px;
        }
        
        .redirect-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #e50914;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e50914, #ff4d4d);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #2a2f36;
            color: #e1e1e1;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #e50914;
            color: white;
            border-color: #e50914;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #2a2f36;
            margin-bottom: 20px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #e50914;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #2a2f36;
            background-color: #1a1f26;
            color: #e1e1e1;
            width: 300px;
        }
        
        .search-button {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            background-color: #e50914;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #2a2f36;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #8a8a8a;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #e50914;
            border-bottom-color: #e50914;
        }
        
        .tab:hover:not(.active) {
            color: #e1e1e1;
        }
        
        .main-content {
            display: flex;
            gap: 30px;
        }
        
        .content-list {
            flex: 1;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .content-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .content-list::-webkit-scrollbar-track {
            background: #1a1f26;
            border-radius: 10px;
        }
        
        .content-list::-webkit-scrollbar-thumb {
            background: #e50914;
            border-radius: 10px;
        }
        
        .content-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #1a1f26;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .content-item:hover {
            background-color: #252b35;
            transform: translateY(-2px);
        }
        
        .content-item.active {
            background-color: #2a2f36;
            border-left: 4px solid #e50914;
        }
        
        .content-poster {
            width: 80px;
            height: 120px;
            border-radius: 4px;
            background-color: #2a2f36;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8a8a8a;
            font-size: 12px;
            text-align: center;
            padding: 5px;
        }
        
        .content-info {
            flex: 1;
        }
        
        .content-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .content-year {
            color: #8a8a8a;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .content-episodes {
            color: #8a8a8a;
            font-size: 14px;
        }
        
        .player-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .video-player {
            width: 100%;
            height: 400px;
            background-color: #000;
        }
        
        /* Personalización de Video.js para tema oscuro */
        .video-js {
            width: 100%;
            height: 100%;
        }
        
        .vjs-theme-netflix {
            --vjs-theme-netflix-primary: #e50914;
        }
        
        .episodes-container {
            background-color: #1a1f26;
            border-radius: 8px;
            padding: 20px;
        }
        
        .episodes-title {
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a2f36;
        }
        
        .episodes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .episodes-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .episodes-list::-webkit-scrollbar-track {
            background: #1a1f26;
            border-radius: 10px;
        }
        
        .episodes-list::-webkit-scrollbar-thumb {
            background: #e50914;
            border-radius: 10px;
        }
        
        .episode-item {
            padding: 10px;
            background-color: #252b35;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .episode-item:hover {
            background-color: #2a2f36;
        }
        
        .episode-item.active {
            background-color: #e50914;
            color: white;
        }
        
        .no-content {
            text-align: center;
            padding: 40px;
            color: #8a8a8a;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #e50914;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        .mini-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #e50914;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        
        .resume-indicator {
            background-color: #e50914;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            
            .content-list {
                max-height: 300px;
            }
            
            .user-info {
                margin-left: 0;
                margin-top: 10px;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .search-input {
                width: 200px;
            }
            
            .episodes-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .video-player {
                height: 300px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .video-player {
                height: 250px;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="redirectOverlay" class="redirect-overlay">
        <div class="redirect-content">
            <div class="redirect-logo">DANILO STREAMING</div>
            <h2 style="color: #e50914; margin-bottom: 20px;">🔒 Acceso Restringido</h2>
            <p style="margin-bottom: 10px; font-size: 16px;">Debes iniciar sesión para acceder a esta página</p>
            <p style="margin-bottom: 30px; color: #8a8a8a;">Redirigiendo al login...</p>
            <div class="redirect-spinner"></div>
            <p style="margin-top: 20px; color: #8a8a8a; font-size: 14px;">
                Si no eres redirigido automáticamente, 
                <a href="index.html" style="color: #e50914; text-decoration: none;">haz clic aquí</a>
            </p>
        </div>
    </div>

    <!-- Contenido principal (se muestra solo si hay sesión) -->
    <div id="mainContent">
        <div class="container">
            <header>
                <div class="logo">DANILO STREAMING</div>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Buscar contenido...">
                    <button class="search-button">Buscar</button>
                </div>
                <div class="user-info" id="userInfo">
                    <!-- Se llena dinámicamente con JavaScript -->
                </div>
            </header>
            
            <div class="tabs">
                <button class="tab active" data-tab="movies">Películas</button>
                <button class="tab" data-tab="series">Series</button>
            </div>
            
            <div class="main-content">
                <div class="content-list" id="contentList">
                    <!-- El contenido se cargará aquí dinámicamente -->
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div class="player-container">
                    <div class="video-container">
                        <video 
                            id="videoPlayer" 
                            class="video-js vjs-theme-netflix vjs-big-play-centered" 
                            controls 
                            preload="metadata"
                            poster="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDgwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiMxYTFmMjYiLz48dGV4dCB4PSI0MDAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmaWxsPSIjOGE4YThhIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zNWVtIj5TZWxlY2Npb25hIHVuIGNvbnRlbmlkbzwvdGV4dD48L3N2Zz4=="
                        >
                            <p class="vjs-no-js">
                                Para ver este video, habilita JavaScript y considera actualizar a un navegador web que
                                <a href="https://videojs.com/html5-video-support/" target="_blank">soporte video HTML5</a>
                            </p>
                        </video>
                    </div>
                    
                    <div class="episodes-container" id="episodesContainer" style="display: none;">
                        <h2 class="episodes-title">Episodios</h2>
                        <div class="episodes-list" id="episodesList">
                            <div class="no-content">Selecciona una serie para ver sus episodios</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video.js Script -->
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    
    <script>
        // =============================================
        // SISTEMA DE VALIDACIÓN DE SESIÓN - CORREGIDO
        // =============================================
        
        // Verificar si el usuario está autenticado
        function checkAuthentication() {
            const currentUser = localStorage.getItem('currentUser');
            const authToken = localStorage.getItem('authToken');
            
          
            
            if (!currentUser || !authToken) {
                console.log('❌ No hay sesión activa');
                return false;
            }
            
            try {
                const user = JSON.parse(currentUser);
                return true;
            } catch (error) {
                console.error('❌ Error verificando autenticación:', error);
                return false;
            }
        }
        
        // Mostrar pantalla de redirección al login
        function showRedirectScreen() {
            console.log('🔄 Mostrando pantalla de redirección...');
            document.getElementById('redirectOverlay').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            
            // Redirigir después de 3 segundos
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 3000);
        }
        
        // Mostrar contenido principal
        function showMainContent() {
            document.getElementById('redirectOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }
        
        // Limpiar datos de sesión
        function clearSession() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
        }
        
        // Mostrar información del usuario en el header
        function displayUserInfo() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) return;
                
                const userInfo = document.getElementById('userInfo');
                userInfo.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="user-avatar">
                            ${currentUser.nombre.charAt(0).toUpperCase()}
                        </div>
                        <span style="color: #e1e1e1;">Hola, ${currentUser.nombre}</span>
                    </div>
                    <button class="logout-btn" id="logoutBtn">
                        Cerrar Sesión
                    </button>
                `;
                
                // Configurar evento de logout
                document.getElementById('logoutBtn').addEventListener('click', function() {
                    if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                        // Limpiar datos de sesión
                        clearSession();
                        
                        // Mostrar mensaje de despedida
                        alert('Sesión cerrada correctamente');
                        
                        // Redirigir al login
                        window.location.href = 'index.html';
                    }
                });
                
            } catch (error) {
                console.error('Error mostrando información del usuario:', error);
            }
        }

        // =============================================
        // SISTEMA DE REPRODUCCIÓN (CÓDIGO EXISTENTE)
        // =============================================
        
        // Variables globales
        let moviesData = [];
        let seriesData = [];
        let groupedSeries = {};
        let currentContent = null;
        let currentEpisode = null;
        let videoPlayer = null;
        let currentTab = 'movies';
        let currentImageLoader = null;
        let playbackProgressInterval = null;
        let isPlaying = false;
        
        // Clave para localStorage
        const STORAGE_KEYS = {
            CURRENT_CONTENT: 'uniflix_current_content',
            PLAYBACK_PROGRESS: 'uniflix_playback_progress',
            CURRENT_TAB: 'uniflix_current_tab'
        };
        
        // Inicializar Video.js
        function initializeVideoPlayer() {
            videoPlayer = videojs('videoPlayer', {
                controls: true,
                autoplay: false,
                preload: 'metadata',
                fluid: true,
                responsive: true,
                playbackRates: [0.5, 1, 1.25, 1.5, 2],
                html5: {
                    vhs: {
                        overrideNative: true
                    }
                }
            });
            
            // Restaurar progreso de reproducción si existe
            restorePlaybackProgress();
            
            // Guardar progreso cada 5 segundos durante la reproducción
            videoPlayer.on('timeupdate', function() {
                if (videoPlayer.duration() > 0) {
                    savePlaybackProgress();
                }
            });
            
            // Manejar eventos de reproducción
            videoPlayer.on('play', function() {
                isPlaying = true;
                startPlaybackTracking();
            });
            
            videoPlayer.on('pause', function() {
                isPlaying = false;
                stopPlaybackTracking();
                savePlaybackProgress();
            });
            
            videoPlayer.on('ended', function() {
                isPlaying = false;
                stopPlaybackTracking();
                // Limpiar progreso guardado cuando el video termina
                localStorage.removeItem(STORAGE_KEYS.PLAYBACK_PROGRESS);
                localStorage.removeItem(STORAGE_KEYS.CURRENT_CONTENT);
            });
            
            // Manejar errores del reproductor
            videoPlayer.on('error', function() {
                console.error('Error en el reproductor de video');
                videoPlayer.poster('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDgwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiMxYTFmMjYiLz48dGV4dCB4PSI0MDAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmaWxsPSIjOGE4YThhIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zNWVtIj5FcnJvciBjYXJnYW5kbyBlbCB2aWRlbzwvdGV4dD48L3N2Zz4=');
            });
        }
        
        // Iniciar seguimiento de reproducción
        function startPlaybackTracking() {
            if (playbackProgressInterval) {
                clearInterval(playbackProgressInterval);
            }
            
            // Guardar progreso cada 5 segundos
            playbackProgressInterval = setInterval(function() {
                if (videoPlayer && !videoPlayer.paused()) {
                    savePlaybackProgress();
                }
            }, 5000);
        }
        
        // Detener seguimiento de reproducción
        function stopPlaybackTracking() {
            if (playbackProgressInterval) {
                clearInterval(playbackProgressInterval);
                playbackProgressInterval = null;
            }
        }
        
        // Guardar progreso de reproducción
        function savePlaybackProgress() {
            if (videoPlayer && currentContent && videoPlayer.duration() > 0) {
                const progress = {
                    contentId: currentContent.url || currentContent.title,
                    currentTime: videoPlayer.currentTime(),
                    duration: videoPlayer.duration(),
                    timestamp: Date.now(),
                    type: currentTab,
                    episode: currentEpisode ? currentEpisode.title : null
                };
                
                localStorage.setItem(STORAGE_KEYS.PLAYBACK_PROGRESS, JSON.stringify(progress));
                
                // Guardar también el contenido actual
                const currentContentData = {
                    title: currentContent.title,
                    url: currentContent.url,
                    logo: currentContent.logo,
                    type: currentTab,
                    episode: currentEpisode
                };
                
                localStorage.setItem(STORAGE_KEYS.CURRENT_CONTENT, JSON.stringify(currentContentData));
            }
        }
        
        // Restaurar progreso de reproducción
        function restorePlaybackProgress() {
            try {
                const savedProgress = localStorage.getItem(STORAGE_KEYS.PLAYBACK_PROGRESS);
                const savedContent = localStorage.getItem(STORAGE_KEYS.CURRENT_CONTENT);
                
                if (savedProgress && savedContent) {
                    const progress = JSON.parse(savedProgress);
                    const content = JSON.parse(savedContent);
                    
                    // Solo restaurar si el progreso es reciente (menos de 24 horas)
                    const isRecent = (Date.now() - progress.timestamp) < (24 * 60 * 60 * 1000);
                    
                    if (isRecent) {
                
                    } else {
                        // Limpiar progreso antiguo
                        localStorage.removeItem(STORAGE_KEYS.PLAYBACK_PROGRESS);
                        localStorage.removeItem(STORAGE_KEYS.CURRENT_CONTENT);
                    }
                }
            } catch (error) {
                console.error('Error al restaurar el progreso:', error);
            }
        }
        
        // Cargar datos iniciales
        async function loadInitialData() {
            try {

                // Cargar películas
                await loadMoviesData();
                
                // Cargar series
                await loadSeriesData();
                
                // Restaurar pestaña activa
                const savedTab = localStorage.getItem(STORAGE_KEYS.CURRENT_TAB);
                if (savedTab) {
                    currentTab = savedTab;
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.getAttribute('data-tab') === savedTab) {
                            tab.classList.add('active');
                        }
                    });
                }
                
                // Mostrar contenido según la pestaña
                if (currentTab === 'movies') {
                    showMovies();
                } else {
                    showSeries();
                }
                
                // Intentar restaurar contenido anterior
                restorePreviousContent();
                
            } catch (error) {
                console.error('❌ Error al cargar los datos iniciales:', error);
                document.getElementById('contentList').innerHTML = '<div class="no-content">Error al cargar el contenido</div>';
            }
        }
        
        // Restaurar contenido anterior
        function restorePreviousContent() {
            try {
                const savedContent = localStorage.getItem(STORAGE_KEYS.CURRENT_CONTENT);
                const savedProgress = localStorage.getItem(STORAGE_KEYS.PLAYBACK_PROGRESS);
                
                if (savedContent && savedProgress) {
                    const content = JSON.parse(savedContent);
                    const progress = JSON.parse(savedProgress);
                    
                    // Verificar que el progreso sea reciente
                    const isRecent = (Date.now() - progress.timestamp) < (24 * 60 * 60 * 1000);
                    
                    if (isRecent) {
                        // Buscar y seleccionar el contenido guardado
                        if (content.type === 'movies') {
                            const movie = moviesData.find(m => m.url === content.url);
                            if (movie) {
                                // Simular clic en el elemento de contenido
                                setTimeout(() => {
                                    const movieItems = document.querySelectorAll('.content-item');
                                    movieItems.forEach(item => {
                                        if (item.getAttribute('data-url') === content.url) {
                                            selectMovie(item);
                                            
                                            // Una vez cargado, restaurar el tiempo
                                            videoPlayer.ready(function() {
                                                setTimeout(() => {
                                                    if (videoPlayer.duration() > 0) {
                                                        videoPlayer.currentTime(progress.currentTime);
                                                        
                                                    }
                                                }, 1000);
                                            });
                                        }
                                    });
                                }, 500);
                            }
                        } else if (content.type === 'series' && content.episode) {
                            console.log('📺 Restaurando serie:', content);
                        }
                    }
                }
            } catch (error) {
                console.error('Error al restaurar contenido anterior:', error);
            }
        }
        
        // Cargar datos de películas
        async function loadMoviesData() {
            try {
                const response = await fetch('movies.json');
                moviesData = await response.json();
                console.log(`🎬 ${moviesData.length} películas cargadas`);
            } catch (error) {
                console.error('❌ Error cargando películas:', error);
                moviesData = [];
            }
        }
        
        // Cargar datos de series
        async function loadSeriesData() {
            try {
                const response = await fetch('series.json');
                seriesData = await response.json();
                
                // Agrupar series
                groupedSeries = groupSeriesByTitle(seriesData);
                console.log(`📺 ${Object.keys(groupedSeries).length} series cargadas`);
            } catch (error) {
                console.error('❌ Error cargando series:', error);
                seriesData = [];
                groupedSeries = {};
            }
        }
        
        // Agrupar episodios por serie
        function groupSeriesByTitle(series) {
            const grouped = {};
            
            series.forEach(item => {
                const baseTitle = item.title.split(' S')[0];
                
                if (!grouped[baseTitle]) {
                    grouped[baseTitle] = {
                        title: baseTitle,
                        episodes: [],
                        logo: item.logo,
                        firstEpisode: item
                    };
                }
                
                const seasonMatch = item.title.match(/S(\d+)/);
                const episodeMatch = item.title.match(/E(\d+)/);
                
                grouped[baseTitle].episodes.push({
                    title: item.title,
                    season: seasonMatch ? parseInt(seasonMatch[1]) : 1,
                    episode: episodeMatch ? parseInt(episodeMatch[1]) : 1,
                    url: item.url,
                    logo: item.logo
                });
            });
            
            // Ordenar episodios
            Object.keys(grouped).forEach(title => {
                grouped[title].episodes.sort((a, b) => {
                    if (a.season !== b.season) {
                        return a.season - b.season;
                    }
                    return a.episode - b.episode;
                });
            });
            
            return grouped;
        }
        
        // Mostrar películas
        function showMovies() {
            currentTab = 'movies';
            localStorage.setItem(STORAGE_KEYS.CURRENT_TAB, currentTab);
            renderContentTitles(moviesData, 'movie');
            hideEpisodesContainer();
            clearVideoPlayer();
        }
        
        // Mostrar series
        function showSeries() {
            currentTab = 'series';
            localStorage.setItem(STORAGE_KEYS.CURRENT_TAB, currentTab);
            renderContentTitles(groupedSeries, 'series');
            hideEpisodesContainer();
            clearVideoPlayer();
        }
        
        // Renderizar solo títulos de contenido (sin imágenes)
        function renderContentTitles(content, type) {
            const contentList = document.getElementById('contentList');
            
            if ((type === 'movie' && content.length === 0) || 
                (type === 'series' && Object.keys(content).length === 0)) {
                contentList.innerHTML = '<div class="no-content">No se encontró contenido</div>';
                return;
            }
            
            let html = '';
            
            if (type === 'movie') {
                content.forEach(item => {
                    const year = item.year || '2025';
                    const savedProgress = getSavedProgressForContent(item.url);
                    const hasProgress = savedProgress && savedProgress.currentTime > 0;
                    
                    html += `
                        <div class="content-item" data-url="${item.url}" data-title="${item.title}" data-logo="${item.logo}" data-year="${year}">
                            <div class="content-poster">Clic para cargar</div>
                            <div class="content-info">
                                <div class="content-title">${item.title}</div>
                                <div class="content-year">${year}</div>
                                ${hasProgress ? '<div class="resume-indicator">Continuar viendo</div>' : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                Object.values(content).forEach(series => {
                    const savedProgress = getSavedProgressForContent(series.title);
                    const hasProgress = savedProgress && savedProgress.currentTime > 0;
                    
                    html += `
                        <div class="content-item" data-title="${series.title}" data-logo="${series.firstEpisode.logo}">
                            <div class="content-poster">Clic para cargar</div>
                            <div class="content-info">
                                <div class="content-title">${series.title}</div>
                                <div class="content-year">2025</div>
                                <div class="content-episodes">${series.episodes.length} episodios</div>
                                ${hasProgress ? '<div class="resume-indicator">Continuar viendo</div>' : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            contentList.innerHTML = html;
            
            // Agregar event listeners
            document.querySelectorAll('.content-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (type === 'movie') {
                        selectMovie(this);
                    } else {
                        const title = this.getAttribute('data-title');
                        selectSeries(title, content[title], this);
                    }
                });
            });
        }
        
        // Obtener progreso guardado para un contenido específico
        function getSavedProgressForContent(contentId) {
            try {
                const savedProgress = localStorage.getItem(STORAGE_KEYS.PLAYBACK_PROGRESS);
                if (savedProgress) {
                    const progress = JSON.parse(savedProgress);
                    if (progress.contentId === contentId) {
                        return progress;
                    }
                }
            } catch (error) {
                console.error('Error al obtener progreso guardado:', error);
            }
            return null;
        }
        
        // Seleccionar película
        async function selectMovie(movieItem) {
            // Cancelar carga de imagen anterior si existe
            if (currentImageLoader) {
                currentImageLoader = null;
            }
            
            clearSelections();
            movieItem.classList.add('active');
            
            const url = movieItem.getAttribute('data-url');
            const title = movieItem.getAttribute('data-title');
            const logo = movieItem.getAttribute('data-logo');
            
            // Cargar imagen solo cuando se selecciona
            await loadContentImage(movieItem, logo);
            
            currentContent = { url, title, logo };
            currentEpisode = null;
            
            // Obtener progreso guardado si existe
            const savedProgress = getSavedProgressForContent(url);
            
            playContent(url, logo, savedProgress);
        }
        
        // Seleccionar serie
        async function selectSeries(title, series, seriesItem) {
            // Cancelar carga de imagen anterior si existe
            if (currentImageLoader) {
                currentImageLoader = null;
            }
            
            clearSelections();
            seriesItem.classList.add('active');
            
            // Cargar imagen solo cuando se selecciona
            await loadContentImage(seriesItem, series.firstEpisode.logo);
            
            currentContent = series;
            currentEpisode = null;
            
            // Mostrar contenedor de episodios
            showEpisodesContainer();
            
            // Renderizar lista de episodios
            renderEpisodesList(series.episodes);
            
            clearVideoPlayer();
        }
        
        // Cargar imagen de contenido (solo cuando se selecciona)
        function loadContentImage(contentItem, imageUrl) {
            return new Promise((resolve) => {
                const poster = contentItem.querySelector('.content-poster');
                
                // Mostrar spinner mientras carga
                poster.innerHTML = '<div class="mini-spinner"></div>';
                
                const img = new Image();
                
                img.onload = function() {
                    poster.style.backgroundImage = `url('${imageUrl}')`;
                    poster.innerHTML = '';
                    resolve();
                };
                
                img.onerror = function() {
                    poster.style.backgroundImage = "url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgODAgMTIwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI4MCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMxYTFmMjYiLz48dGV4dCB4PSI0MCIgeT0iNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzhhOGE4YSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjAuMzVlbSI+RXJyb3I8L3RleHQ+PC9zdmc+')";
                    poster.innerHTML = '';
                    resolve();
                };
                
                img.src = imageUrl;
                currentImageLoader = img;
            });
        }
        
        // Renderizar lista de episodios
        function renderEpisodesList(episodes) {
            const episodesList = document.getElementById('episodesList');
            
            if (episodes.length === 0) {
                episodesList.innerHTML = '<div class="no-content">No hay episodios disponibles</div>';
                return;
            }
            
            let html = '';
            
            episodes.forEach(episode => {
                const savedProgress = getSavedProgressForContent(episode.url);
                const hasProgress = savedProgress && savedProgress.currentTime > 0;
                
                html += `
                    <div class="episode-item" data-url="${episode.url}" data-title="${episode.title}">
                        S${episode.season.toString().padStart(2, '0')}E${episode.episode.toString().padStart(2, '0')}
                        ${hasProgress ? '<div class="resume-indicator">●</div>' : ''}
                    </div>
                `;
            });
            
            episodesList.innerHTML = html;
            
            // Agregar event listeners a los episodios
            document.querySelectorAll('.episode-item').forEach(item => {
                item.addEventListener('click', function() {
                    const url = this.getAttribute('data-url');
                    const title = this.getAttribute('data-title');
                    
                    // Limpiar selección anterior de episodios
                    document.querySelectorAll('.episode-item').forEach(ep => {
                        ep.classList.remove('active');
                    });
                    
                    // Marcar como activo
                    this.classList.add('active');
                    
                    currentEpisode = { url, title };
                    
                    // Obtener progreso guardado si existe
                    const savedProgress = getSavedProgressForContent(url);
                    
                    playContent(url, currentContent.firstEpisode.logo, savedProgress);
                });
            });
        }
        
        // Reproducir contenido
        function playContent(url, poster, savedProgress = null) {
            // Detener seguimiento actual
            stopPlaybackTracking();
            
            // Configurar y cargar nuevo video
            //videoPlayer.src({
               // src: url,
                //type: 'video/mp4'
            //});
			videoPlayer.src({
				src: 'proxy.php?url=' + encodeURIComponent(url),
				type: 'video/mp4'
			});
            
            // Actualizar poster
            if (poster) {
                videoPlayer.poster(poster);
            }
            
            // Si hay progreso guardado, restaurarlo cuando el video esté listo
            if (savedProgress && savedProgress.currentTime > 0) {
                videoPlayer.ready(function() {
                    // Esperar a que el video tenga metadatos cargados
                    if (videoPlayer.duration() > 0) {
                        videoPlayer.currentTime(savedProgress.currentTime);
                        
                    } else {
                        // Si no hay duración aún, esperar al evento loadedmetadata
                        videoPlayer.one('loadedmetadata', function() {
                            videoPlayer.currentTime(savedProgress.currentTime);
                           
                        });
                    }
                });
            }
            
            // Iniciar seguimiento de reproducción cuando comience a reproducirse
            videoPlayer.one('play', function() {
                startPlaybackTracking();
            });
        }
        
        // Limpiar selecciones
        function clearSelections() {
            document.querySelectorAll('.content-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.episode-item').forEach(item => {
                item.classList.remove('active');
            });
        }
        
        // Mostrar contenedor de episodios
        function showEpisodesContainer() {
            document.getElementById('episodesContainer').style.display = 'block';
        }
        
        // Ocultar contenedor de episodios
        function hideEpisodesContainer() {
            document.getElementById('episodesContainer').style.display = 'none';
        }
        
        // Limpiar el reproductor de video completamente
        function clearVideoPlayer() {
            if (videoPlayer) {
                // Detener seguimiento
                stopPlaybackTracking();
                
                // Solo limpiar si no se está reproduciendo
                if (!isPlaying) {
                    videoPlayer.pause();
                    videoPlayer.reset();
                    
                    // Limpiar fuente
                    videoPlayer.src('');
                    
                    // Limpiar poster
                    videoPlayer.poster('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDgwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiMxYTFmMjYiLz48dGV4dCB4PSI0MDAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmaWxsPSIjOGE4YThhIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zNWVtIj5TZWxlY2Npb25hIHVuIGNvbnRlbmlkbzwvdGV4dD48L3N2Zz4=');
                }
            }
        }
        
        // =============================================
        // INICIALIZACIÓN DE LA APLICACIÓN - CORREGIDA
        // =============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            
            // Primero verificar la autenticación
            if (checkAuthentication()) {
                // Si está autenticado, mostrar el contenido principal
                showMainContent();
                displayUserInfo();
                
                // Inicializar Video.js
                initializeVideoPlayer();
                
                // Cargar datos iniciales
                loadInitialData();
                
                // Configurar pestañas
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        
                        const tabType = this.getAttribute('data-tab');
                        
                        if (tabType === 'movies') {
                            showMovies();
                        } else {
                            showSeries();
                        }
                    });
                });
                
                // Configurar búsqueda
                document.querySelector('.search-button').addEventListener('click', function() {
                    const searchTerm = document.querySelector('.search-input').value.toLowerCase();
                    performSearch(searchTerm);
                });
                
                document.querySelector('.search-input').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const searchTerm = this.value.toLowerCase();
                        performSearch(searchTerm);
                    }
                });
                
                // Función de búsqueda
                function performSearch(searchTerm) {
                    if (currentTab === 'movies') {
                        const filteredMovies = moviesData.filter(movie => 
                            movie.title.toLowerCase().includes(searchTerm)
                        );
                        renderContentTitles(filteredMovies, 'movie');
                    } else {
                        const filteredSeries = Object.keys(groupedSeries)
                            .filter(title => title.toLowerCase().includes(searchTerm))
                            .reduce((obj, key) => {
                                obj[key] = groupedSeries[key];
                                return obj;
                            }, {});
                        renderContentTitles(filteredSeries, 'series');
                    }
                }
                
                // Limpiar recursos al cerrar la página
                window.addEventListener('beforeunload', function() {
                    if (videoPlayer) {
                        // Guardar progreso final
                        savePlaybackProgress();
                    }
                });
                
            } else {
                // Si no está autenticado, mostrar pantalla de redirección
                showRedirectScreen();
            }
        });
    </script>
</body>
</html>